<!DOCTYPE html>
<html lang="vi" ng-app="hlsApp" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·∫•y HLS M3U</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/hls.js/latest/hls.js"></script>
    <script src="./js/clappr.min.js"></script>
    <script src="./js/level-selector.min.js"></script>
    <script src="./js/clappr-pip.min.js"></script>
    <script src="./js/dash-shaka-playback.js"></script>
</head>
<body ng-controller="HLSController" class="h-full w-full bg-gray-100 flex flex-col items-center justify-cente p-4">
    <div class="flex flex-col flex-grow h-0 w-full container gap-1">
        <div class="bg-black w-full flex flex-col lg:flex-row justify-center">
            <div class="w-full lg:w-8/12 min-w-8/12" style="aspect-ratio: 16/9;min-width: 66.666667%;">
                <div id="player" class="h-full"></div>
            </div>
            <div class="bg-white lg:flex-grow flex flex-col">
                <div ng-click="schedule.collapsed = !schedule.collapsed" class="font-bold text-lg p-2 shadow z-10 cursor-pointer flex gap-1">
                    L·ªãch ph√°t s√≥ng
                    <span ng-if="schedule.collapsed">‚ñº</span><span ng-if="!schedule.collapsed">‚ñ≤</span>
                </div>
                <ul ng-if="!schedule.collapsed" class="overflow-auto flex-grow h-0 space-y-2 p-2" style="min-height: 24rem;">
                    <li id="schedule-{{schedule.start}}-{{schedule.stop}}" ng-repeat="schedule in schedules" class="flex p-4 bg-white rounded-lg shadow transition" ng-class="{'bg-yellow-200': currentPlayingSchedule === schedule}">
                        <span class="flex-shrink-0">
                            <span class="font-semibold text-gray-700">{{ formatTime(schedule.start) }}</span>
                        </span>
                        <div class="flex-grow ml-4">
                            <div class="font-bold text-lg text-gray-900">
                                {{schedule.title}}
                            </div>
                            <div class="italic text-gray-600">
                                {{schedule.description}}
                            </div>
                        </div>
                    </li>
                    <li ng-if="!schedules">Kh√¥ng c√≥ l·ªãch ph√°t s√≥ng</li>
                </ul>
            </div>
        </div>
        <div id="currentChannel" class="text-xl font-semibold text-gray-900 mb-2"></div>
        <div class="overflow-auto h-full flex-grow px-4 -mx-4" style="min-height: 24rem;">
            <div ng-repeat="group in groups" class="mb-6">
                <h3 ng-click="group.collapsed = !group.collapsed" ng-if="group.channels.length > 0" class="cursor-pointer text-xl font-bold text-gray-800 mb-2 flex gap-1">
                    <span>{{ group.name }}</span>
                    <span ng-if="group.collapsed">‚ñº</span><span ng-if="!group.collapsed">‚ñ≤</span>
                </h3>
                <div ng-if="group.channels.length > 0 && !group.collapsed" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div ng-if="channel.name" ng-repeat="channel in group.channels" class="flex items-center bg-white rounded-lg p-4 shadow-md cursor-pointer transition-transform transform hover:scale-105 hover:shadow-lg" ng-click="loadVideo(channel.urls, channel.license, channel.clearkeys, 0)">
                        <img ng-src="{{channel.logo}}" alt="{{channel.name}}" class="w-32 h-16 mr-4 object-contain rounded-lg" onerror="angular.element(this).scope().handleImgError(this, angular.element(this).scope().channel)" style="filter: drop-shadow(0 0 0.25rem rgb(0, 0, 0, .1));">
                        <div class="flex-1">
                            <h2 class="text-lg font-semibold text-gray-900">{{channel.name}}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="showOutput" class="mt-4 bg-blue-700 text-white rounded-lg p-3 hover:bg-blue-800 transition" ng-click="showOutput()">Hi·ªán danh s√°ch HLS</button>
    </div>

    <!-- Popup cho textarea -->
    <div id="outputPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" ng-show="popupVisible">
        <div class="bg-white rounded-lg p-6 w-8/12 shadow-lg">
            <h2 class="text-xl font-bold mb-2">Danh s√°ch HLS</h2>
            <pre class="outline-none p-2 w-full overflow-auto" style="max-height: 400px; background-color: #f8f8f8; border: 1px solid #ddd; border-radius: 4px;">
                <code style="color: #333; font-family: monospace;">{{hlsOutput}}</code>
            </pre>
            <button id="copyButton" class="mt-2 bg-green-500 text-white rounded-lg p-2 hover:bg-green-600 transition" ng-click="copyToClipboard()">Sao ch√©p</button>
            <button id="closePopup" class="mt-2 bg-red-500 text-white rounded-lg p-2 hover:bg-red-600 transition" ng-click="closePopup()">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        angular.module('hlsApp', [])
            .controller('HLSController', ['$scope', '$http', function ($scope, $http) {
                $scope.groups = [];
                $scope.hlsOutput = '';
                $scope.popupVisible = false;
                $scope.schedules = [];
                $scope.currentPlayingSchedule = null;
                let currentUrlIndex = 0; // Bi·∫øn ƒë·ªÉ theo d√µi ch·ªâ s·ªë URL hi·ªán t·∫°i

                $scope.fetchHLS = function () {
                    $http.get('https://api.npoint.io/39fe20f4c3372eb4a5b6').then(function (response) {
                        const data = response.data;
                        const m3uContent = [];
                        m3uContent.push(`#${new Date()}`);
                        m3uContent.push(`#EXTM3U url-tvg="http://lichphatsong.xyz/schedule/epg.xml"`);

                        data.forEach(group => {
                            const groupChannels = [];
                            m3uContent.push(``);
                            m3uContent.push(`#==========================================================================================================`);
                            m3uContent.push(``);

                            group.chanel.forEach(channel => {
                                const urls = channel.url.split(',');
                                let existingChannel = $scope.groups.flatMap(g => g.channels).find(c => c.id === channel.id);
                                if (!existingChannel) {
                                    existingChannel = {
                                        id: channel.id || channel.name,
                                        name: channel.name,
                                        logo: channel.logo,
                                        urls: [] // Thay ƒë·ªïi ƒë·ªÉ l∆∞u tr·ªØ nhi·ªÅu URL
                                    };
                                    groupChannels.push(existingChannel);
                                }
                                urls.forEach(url => {
                                    let logo = channel.logo
                                    if (channel.id) {
                                        logo = `https://tchiphuong.github.io/iptv/images/background/${channel.id}.png`;
                                    }
                                    m3uContent.push(`#EXTINF:-1 group-title="${group.groupName}" tvg-id="${channel.id}" tvg-logo="${logo}",${channel.name}`);
                                    m3uContent.push(`#EXTVLCOPT:http-user-agent=Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36`);
                                    m3uContent.push(url);
                                    if (url) { // Ki·ªÉm tra n·∫øu URL kh√¥ng r·ªóng
                                        existingChannel.urls.push(url); // Th√™m URL v√†o danh s√°ch c·ªßa k√™nh
                                    }
                                });
                            });

                            $scope.groups.push({ name: group.groupName.replace("K√™nh", "").trim(), channels: groupChannels });
                        });

                        // G·ªçi h√†m fetchData ƒë·ªÉ l·∫•y d·ªØ li·ªáu
                        fetchData();

                        $scope.hlsOutput = m3uContent.join('\n');

                        const firstValidChannel = $scope.groups?.flatMap(g => g.channels).find(c => c.id === 'vtv1hd'); // T√¨m k√™nh c√≥ ID vtv1hd
                        if (firstValidChannel) {
                            $scope.loadVideo(firstValidChannel.urls, firstValidChannel.license, firstValidChannel.clearkeys);
                        } else {
                            console.error('K√™nh vtv1hd kh√¥ng t·ªìn t·∫°i'); // Th√¥ng b√°o n·∫øu kh√¥ng t√¨m th·∫•y k√™nh
                        }
                    });
                };

                let player; // Khai b√°o bi·∫øn player

                $scope.loadVideo = function (urls, license, clearkeys, index = null) {
                    const currentChannelDiv = $('#currentChannel');
                    const url = urls[index ?? currentUrlIndex]

                    // Kh·ªüi t·∫°o Clappr player
                    if (player) {
                        player.destroy(); // H·ªßy player c≈© n·∫øu ƒë√£ t·ªìn t·∫°i
                    }

                    player = new Clappr.Player({
                        source: url, // S·ª≠ d·ª•ng URL hi·ªán t·∫°i
                        parentId: '#player',
                        preload: 'auto',
                        autoPlay: true,
                        width: '100%',
                        height: '100%',
                        fullscreenEnabled: true,
                        hideMediaControl: false,
                        plugins: [LevelSelector, ClapprPip.PipButton, ClapprPip.PipPlugin, DashShakaPlayback],
                        shakaConfiguration: {
                            drm: {
                                servers: {
                                    'com.widevine.alpha': license
                                },
                                clearKeys: null //JSON.parse(clearkeys)
                            },
                        },
                    });

                    // L·∫Øng nghe s·ª± ki·ªán l·ªói
                    player.on(Clappr.Events.PLAYER_ERROR, function (error) {
                        console.error('L·ªói ph√°t video:', error); // Ghi l·∫°i l·ªói v√†o console
                        currentUrlIndex++; // TƒÉng ch·ªâ s·ªë URL

                        if (currentUrlIndex < urls.length) {
                            $scope.loadVideo(urls, license, clearkeys); // G·ªçi l·∫°i h√†m ƒë·ªÉ ph√°t URL ti·∫øp theo
                        } else {
                            alert('K√™nh l·ªói'); // Th√¥ng b√°o khi kh√¥ng c√≤n URL
                            currentUrlIndex = 0; // ƒê·∫∑t l·∫°i ch·ªâ s·ªë n·∫øu ƒë√£ ph√°t h·∫øt
                            player.destroy();
                        }
                    });

                    // T√¨m k√™nh trong t·∫•t c·∫£ c√°c nh√≥m m√† kh√¥ng s·ª≠ d·ª•ng v√≤ng l·∫∑p for
                    const currentChannel = $scope.groups.flatMap(group => group.channels).find(channel => channel.urls.includes(urls[currentUrlIndex]));
                    if (currentChannel) {
                        $scope.fetchSchedule(currentChannel.id);
                        currentChannelDiv.text(`ƒêang ph√°t: ${currentChannel.name}`);
                        document.title = `üî¥ ƒêang ph√°t: ${currentChannel.name}`
                    }
                };

                $scope.fetchSchedule = function (id) {
                    $scope.schedules = null;
                    $http.get(`https://lichphatsong.xyz/schedule/detail?id=${id}`).then(function (response) {
                        if (response.data.data) {
                            $scope.schedules = response.data.data

                            // X√°c ƒë·ªãnh ch∆∞∆°ng tr√¨nh ƒëang ph√°t s√≥ng
                            const currentTime = moment().unix(); // L·∫•y th·ªùi gian hi·ªán t·∫°i
                            const currentSchedule = $scope.schedules.find(schedule =>
                                currentTime >= schedule.start && currentTime <= schedule.stop
                            );
                            if (currentSchedule) {
                                $scope.currentPlayingSchedule = currentSchedule;
                                const scheduleId = `schedule-${currentSchedule.start}-${currentSchedule.stop}`;

                                let attempts = 0;
                                const checkElement = setInterval(() => {
                                    const currentScheduleElement = document.getElementById(scheduleId);
                                    if (currentScheduleElement) {
                                        currentScheduleElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        clearInterval(checkElement); // D·ª´ng ki·ªÉm tra khi t√¨m th·∫•y
                                    } else {
                                        attempts++;
                                        if (attempts > 10) clearInterval(checkElement); // D·ª´ng sau 10 l·∫ßn th·ª≠
                                    }
                                }, 300); // Ki·ªÉm tra m·ªói 300ms
                            }
                        }
                    })
                }

                $scope.showOutput = function () {
                    $scope.popupVisible = true;
                };

                $scope.closePopup = function () {
                    $scope.popupVisible = false;
                };

                $scope.copyToClipboard = function () {
                    const textarea = document.getElementById('hlsOutput');
                    textarea.select();
                    document.execCommand('copy');
                    alert('N·ªôi dung ƒë√£ ƒë∆∞·ª£c sao ch√©p!');
                };

                // G·ªçi h√†m fetchHLS khi kh·ªüi ƒë·ªông
                $scope.fetchHLS();

                $scope.handleImgError = (img, channel) => {
                    channel.imgError = true; // ƒê√°nh d·∫•u ·∫£nh l·ªói ƒë·ªÉ Angular x·ª≠ l√Ω l·∫°i
                    img.src = `https://ui-avatars.com/api/?background=random&format=svg&rounded=true&name=${channel.name}`;
                };

                $scope.formatTime = function (time) {
                    return moment.unix(time).format('HH:mm'); // ƒê·ªãnh d·∫°ng gi·ªù theo ƒë·ªãnh d·∫°ng 24h
                };

                // H√†m ƒë·ªÉ ph√¢n t√≠ch c√∫ ph√°p M3U8 v√† chuy·ªÉn ƒë·ªïi th√†nh JSON
                function parseM3U8(m3u8Data) {
                    const lines = m3u8Data.split('\n');
                    const jsonOutput = [];
                    let currentChannel = null;

                    lines.forEach(line => {
                        if (line.startsWith('#EXTINF:')) {
                            // L·∫•y th√¥ng tin k√™nh
                            const parts = line.split(',');
                            const channelInfo = parts[parts.length - 1].trim();
                            const channelAttributes = parts.slice(0, parts.length - 1).join(' '); // Gh√©p c√°c ph·∫ßn t·ª´ 0 ƒë·∫øn < parts.length - 1
                            const channelId = channelAttributes.match(/tvg-id="([^"]+)"/); // L·∫•y ID t·ª´ c√°c thu·ªôc t√≠nh n·∫øu c√≥
                            const channelLogo = channelAttributes.match(/tvg-logo="([^"]+)"/); // L·∫•y logo t·ª´ c√°c thu·ªôc t√≠nh n·∫øu c√≥
                            const groupName = channelAttributes.match(/group-title="([^"]+)"/); // L·∫•y t√™n nh√≥m t·ª´ c√°c thu·ªôc t√≠nh n·∫øu c√≥
                            const cleanGroupName = groupName ? groupName[1].trim() : 'Kh√°c'; // Gi·ªØ nguy√™n t√™n nh√≥m, m·∫∑c ƒë·ªãnh l√† 'Kh√°c' n·∫øu kh√¥ng c√≥

                            currentChannel = {
                                id: channelId ? channelId[1] : channelInfo, // L∆∞u ID n·∫øu c√≥
                                title: channelInfo,
                                logo: channelLogo ?
                                    channelLogo[1].replace("https://tv.truyenhinh.click/HoiQuanLogo/?logo=", "") :
                                    'https://ui-avatars.com/api/?background=random&format=svg&rounded=true&name=' + channelInfo, // S·ª≠ d·ª•ng link tr·ª±c ti·∫øp
                                url: null, // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau
                                group: cleanGroupName // S·ª≠ d·ª•ng t√™n nh√≥m ƒë√£ l·∫•y
                            };
                        }
                        else if (currentChannel && line.trim() !== '' && !line.startsWith('#EXTVLCOPT')) {
                            // L·∫•y URL c·ªßa k√™nh, b·ªè qua c√°c d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng #EXTVLCOPT
                            currentChannel.url = line.trim();

                            // Ki·ªÉm tra nh√≥m ƒë√£ t·ªìn t·∫°i trong jsonOutput
                            let existingGroup = jsonOutput.find(g => currentChannel.group == g.name);
                            if (!existingGroup) {
                                existingGroup = { name: currentChannel.group, channels: [] };
                                jsonOutput.push(existingGroup);
                            }

                            existingGroup.channels.push({
                                id: currentChannel.id,
                                name: currentChannel.title,
                                logo: currentChannel.logo.replace("https://tv.truyenhinh.click/HoiQuanLogo/?logo=", ""),
                                urls: [currentChannel.url] // Th√™m URL v√†o danh s√°ch
                            });

                            currentChannel = null; // ƒê·∫∑t l·∫°i currentChannel cho k√™nh ti·∫øp theo
                        }
                    });
                    console.log(jsonOutput);
                    return jsonOutput;
                }

                // H√†m ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ trang web
                function fetchData() {
                    fetch('https://raw.githubusercontent.com/luongtamlong/Dak-Lak-IPTV/main/daklakiptv.m3u')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh vƒÉn b·∫£n
                        })
                        .then(m3u8Data => {
                            // Ph√¢n t√≠ch c√∫ ph√°p M3U8
                            const jsonData = parseM3U8(m3u8Data);
                            _jsonData = jsonData
                            // Th√™m d·ªØ li·ªáu v√†o jsonData
                            jsonData.forEach(group => {
                                group.channels.forEach(channel => {
                                    let existingChannel = $scope.groups.flatMap(g => g.channels)?.find(c => c && c.id === channel.id);
                                    if (existingChannel) {
                                        existingChannel.urls = Array.from(new Set(existingChannel.urls.concat(channel.urls))); // ƒê·∫£m b·∫£o danh s√°ch URLs l√† duy nh·∫•t
                                    }
                                    else {
                                        let grName = group.name?.split("|")[1]?.trim() || group.name
                                        let existingGroup = $scope.groups.find(g => g.name === grName);
                                        if (existingGroup) {
                                            existingGroup.channels.push(channel); // Th√™m k√™nh v√†o nh√≥m ƒë√£ t·ªìn t·∫°i
                                        } else {
                                            var gr = {
                                                name: grName,
                                                channels: [channel]
                                            }
                                            $scope.groups.push(gr); // T·∫°o nh√≥m m·ªõi
                                        }
                                    }
                                });
                            });

                            // C·∫≠p nh·∫≠t giao di·ªán
                            $scope.$apply(); // ƒê·∫£m b·∫£o AngularJS bi·∫øt v·ªÅ s·ª± thay ƒë·ªïi
                            console.log($scope.groups)
                        })
                        .catch(error => {
                            console.error('C√≥ l·ªói x·∫£y ra khi l·∫•y d·ªØ li·ªáu:', error);
                        });
                }
            }]);
        var _jsonData = null
    </script>
</body>
</html>